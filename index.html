import React, { useState, useEffect } from 'react';
import { Heart, Shield, Activity, Users, Settings, LogOut, ChevronRight, AlertTriangle, Plus, Trash2, Bell, CheckCircle2 } from 'lucide-react';

const App = () => {
  // Navigation State: 'welcome' | 'login' | 'dashboard' | 'simulation' | 'contacts' | 'activity'
  const [view, setView] = useState('welcome');
  const [user, setUser] = useState(null);
  const [bpm, setBpm] = useState('');
  const [emergencyContacts, setEmergencyContacts] = useState([
    { id: 1, name: 'John Doe', relation: 'Brother', phone: '+1 234 567 890' },
    { id: 2, name: 'Jane Smith', relation: 'Doctor', phone: '+1 987 654 321' }
  ]);
  
  // Simulation State
  const [safetyLimit, setSafetyLimit] = useState(120);
  const [timerSeconds, setTimerSeconds] = useState(10);
  const [isAlerting, setIsAlerting] = useState(false);
  const [countdown, setCountdown] = useState(0);
  const [isEmergencyTriggered, setIsEmergencyTriggered] = useState(false);
  const [isActivityMode, setIsActivityMode] = useState(false);

  // Constants
  const ACTIVITY_BPM_OFFSET = 40; // Higher limit allowed during exercise

  // Effect for Emergency Countdown
  useEffect(() => {
    let interval;
    if (isAlerting && countdown > 0) {
      interval = setInterval(() => {
        setCountdown((prev) => prev - 1);
      }, 1000);
    } else if (isAlerting && countdown === 0) {
      setIsEmergencyTriggered(true);
      clearInterval(interval);
    }
    return () => clearInterval(interval);
  }, [isAlerting, countdown]);

  const handleLogin = (e) => {
    e.preventDefault();
    setUser({ name: 'Demo User' });
    setView('dashboard');
  };

  const startSimulation = () => {
    const currentBpm = parseInt(bpm);
    const effectiveLimit = isActivityMode ? safetyLimit + ACTIVITY_BPM_OFFSET : safetyLimit;

    if (currentBpm > effectiveLimit) {
      setCountdown(timerSeconds);
      setIsAlerting(true);
      setIsEmergencyTriggered(false);
    } else {
      alert("Heart rate within safe parameters.");
    }
  };

  const addContact = (e) => {
    e.preventDefault();
    const name = e.target.contactName.value;
    const phone = e.target.contactPhone.value;
    if (name && phone) {
      setEmergencyContacts([...emergencyContacts, { id: Date.now(), name, relation: 'Added Contact', phone }]);
      e.target.reset();
    }
  };

  const deleteContact = (id) => {
    setEmergencyContacts(emergencyContacts.filter(c => c.id !== id));
  };

  // --- SUB-COMPONENTS ---

  const WelcomePage = () => (
    <div className="flex flex-col items-center justify-center min-h-screen p-6 text-center">
      <div className="w-24 h-24 bg-cyan-500 rounded-full flex items-center justify-center mb-6 shadow-lg shadow-cyan-500/50">
        <Shield size={48} className="text-white" />
      </div>
      <h1 className="text-5xl font-black text-white mb-4">HALO</h1>
      <p className="text-slate-400 max-w-xs mb-10">Advanced heart-rate monitoring and autonomous emergency response simulation.</p>
      <button 
        onClick={() => setView('login')}
        className="w-full max-w-xs bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-4 rounded-2xl transition-all flex items-center justify-center gap-2 group"
      >
        Get Started <ChevronRight className="group-hover:translate-x-1 transition-transform" />
      </button>
    </div>
  );

  const LoginPage = () => (
    <div className="flex flex-col justify-center min-h-screen p-8">
      <h2 className="text-3xl font-bold text-white mb-2">Welcome Back</h2>
      <p className="text-slate-400 mb-8">Login to access your Halo safety profile.</p>
      <form onSubmit={handleLogin} className="space-y-4">
        <input type="email" placeholder="Email Address" required className="w-full bg-slate-800 border border-slate-700 p-4 rounded-xl text-white outline-none focus:ring-2 focus:ring-cyan-500" />
        <input type="password" placeholder="Password" required className="w-full bg-slate-800 border border-slate-700 p-4 rounded-xl text-white outline-none focus:ring-2 focus:ring-cyan-500" />
        <button type="submit" className="w-full bg-cyan-600 py-4 rounded-xl font-bold text-white mt-4">Login</button>
      </form>
      <p className="text-center text-slate-500 mt-6 text-sm">Don't have an account? <span className="text-cyan-400">Sign Up</span></p>
    </div>
  );

  const Dashboard = () => (
    <div className="p-6 pb-24">
      <div className="flex justify-between items-center mb-8 pt-4">
        <div>
          <h2 className="text-2xl font-bold text-white">Hello, {user?.name}</h2>
          <p className="text-slate-400 text-sm">System Status: Active</p>
        </div>
        <button onClick={() => setView('welcome')} className="p-2 bg-slate-800 rounded-lg"><LogOut size={20} className="text-rose-400" /></button>
      </div>

      <div className="grid gap-4">
        {/* Activity Toggle Card */}
        <div className={`p-6 rounded-3xl transition-all border-2 ${isActivityMode ? 'bg-orange-500/20 border-orange-500' : 'bg-slate-800/40 border-slate-700'}`}>
          <div className="flex justify-between items-center">
            <div className="flex items-center gap-3">
              <Activity className={isActivityMode ? 'text-orange-500' : 'text-slate-400'} />
              <div>
                <h3 className="font-bold text-white">Physical Activity Mode</h3>
                <p className="text-xs text-slate-400">Adjusts threshold for exercise</p>
              </div>
            </div>
            <button 
              onClick={() => setIsActivityMode(!isActivityMode)}
              className={`w-12 h-6 rounded-full relative transition-colors ${isActivityMode ? 'bg-orange-500' : 'bg-slate-600'}`}
            >
              <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${isActivityMode ? 'right-1' : 'left-1'}`} />
            </button>
          </div>
        </div>

        {/* Simulation Settings Card */}
        <div className="bg-slate-800/40 p-6 rounded-3xl border border-slate-700">
          <h3 className="font-bold text-white mb-4 flex items-center gap-2"><Settings size={18}/> Monitor Config</h3>
          <div className="space-y-4">
            <div>
              <label className="text-xs text-slate-500 uppercase font-bold">Base BPM Limit</label>
              <input type="number" value={safetyLimit} onChange={(e) => setSafetyLimit(parseInt(e.target.value))} className="w-full bg-slate-900 mt-1 p-3 rounded-xl border border-slate-700" />
            </div>
            <div>
              <label className="text-xs text-slate-500 uppercase font-bold">Emergency Delay (Sec)</label>
              <input type="number" value={timerSeconds} onChange={(e) => setTimerSeconds(parseInt(e.target.value))} className="w-full bg-slate-900 mt-1 p-3 rounded-xl border border-slate-700" />
            </div>
          </div>
        </div>

        {/* Start Button */}
        <div className="bg-cyan-600 p-6 rounded-3xl text-center cursor-pointer hover:bg-cyan-500 transition-all shadow-lg shadow-cyan-900/20" onClick={() => setView('simulation')}>
          <div className="text-white font-bold text-lg">Launch Simulation Monitor</div>
          <div className="text-cyan-200 text-xs">Test emergency protocols</div>
        </div>
      </div>
    </div>
  );

  const ContactsPage = () => (
    <div className="p-6 pb-24">
      <h2 className="text-2xl font-bold text-white mb-6">Emergency Contacts</h2>
      
      <form onSubmit={addContact} className="bg-slate-800/40 p-6 rounded-3xl border border-slate-700 mb-6">
        <h3 className="text-sm font-bold text-slate-400 mb-4 uppercase">Add New Contact</h3>
        <input name="contactName" placeholder="Name" required className="w-full bg-slate-900 p-3 rounded-xl mb-3 border border-slate-700 text-white" />
        <input name="contactPhone" placeholder="Phone Number" required className="w-full bg-slate-900 p-3 rounded-xl mb-4 border border-slate-700 text-white" />
        <button type="submit" className="w-full bg-emerald-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2"><Plus size={18}/> Add Contact</button>
      </form>

      <div className="space-y-4">
        {emergencyContacts.map(contact => (
          <div key={contact.id} className="bg-slate-800/40 p-4 rounded-2xl border border-slate-700 flex justify-between items-center">
            <div>
              <div className="font-bold text-white">{contact.name}</div>
              <div className="text-xs text-slate-400">{contact.relation} • {contact.phone}</div>
            </div>
            <button onClick={() => deleteContact(contact.id)} className="text-rose-500 p-2"><Trash2 size={18}/></button>
          </div>
        ))}
      </div>
    </div>
  );

  const SimulationView = () => (
    <div className="p-6 flex flex-col items-center justify-center min-h-[80vh]">
      <div className="text-center mb-8">
        <div className={`w-32 h-32 rounded-full mx-auto mb-6 flex items-center justify-center border-4 border-slate-700 ${isActivityMode ? 'bg-orange-500/10 border-orange-500/30' : 'bg-cyan-500/10 border-cyan-500/30'}`}>
          <Heart size={48} className={`${isActivityMode ? 'text-orange-500' : 'text-cyan-500'} animate-pulse`} />
        </div>
        <div className="text-sm text-slate-500 font-bold uppercase tracking-widest mb-1">Live Simulation</div>
        <div className="text-5xl font-black text-white">{bpm || '--'} <span className="text-lg text-slate-500">BPM</span></div>
      </div>

      <div className="w-full max-w-xs space-y-4">
        <input 
          type="number" 
          value={bpm} 
          onChange={(e) => setBpm(e.target.value)}
          placeholder="Input simulated BPM..." 
          className="w-full bg-slate-800 p-4 rounded-2xl text-center text-xl font-bold outline-none focus:ring-2 focus:ring-rose-500 transition-all" 
        />
        <button 
          onClick={startSimulation}
          className="w-full bg-rose-600 hover:bg-rose-500 py-4 rounded-2xl font-bold text-lg shadow-lg"
        >
          Check Pulse
        </button>
        <button onClick={() => setView('dashboard')} className="w-full text-slate-500 font-bold py-2">Back to Dashboard</button>
      </div>

      {isActivityMode && (
        <div className="mt-8 px-4 py-2 bg-orange-500/20 text-orange-400 rounded-full text-xs font-bold border border-orange-500/30">
          ACTIVITY MODE ACTIVE (+{ACTIVITY_BPM_OFFSET} BPM Safety Buffer)
        </div>
      )}
    </div>
  );

  return (
    <div className="bg-slate-900 min-h-screen text-slate-200 font-sans max-w-md mx-auto relative overflow-hidden shadow-2xl">
      
      {/* View Logic */}
      {view === 'welcome' && <WelcomePage />}
      {view === 'login' && <LoginPage />}
      {view === 'dashboard' && <Dashboard />}
      {view === 'contacts' && <ContactsPage />}
      {view === 'simulation' && <SimulationView />}

      {/* Persistent Navigation (Visible in main app views) */}
      {(view === 'dashboard' || view === 'contacts') && (
        <div className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-slate-900/80 backdrop-blur-md border-t border-slate-800 p-4 flex justify-around">
          <button onClick={() => setView('dashboard')} className={`flex flex-col items-center gap-1 ${view === 'dashboard' ? 'text-cyan-400' : 'text-slate-500'}`}>
            <Activity size={20} />
            <span className="text-[10px] font-bold">DASHBOARD</span>
          </button>
          <button onClick={() => setView('contacts')} className={`flex flex-col items-center gap-1 ${view === 'contacts' ? 'text-cyan-400' : 'text-slate-500'}`}>
            <Users size={20} />
            <span className="text-[10px] font-bold">CONTACTS</span>
          </button>
        </div>
      )}

      {/* Emergency Overlay */}
      {isAlerting && (
        <div className="fixed inset-0 z-50 bg-slate-950/95 flex items-center justify-center p-8 backdrop-blur-sm">
          <div className="w-full text-center">
            {!isEmergencyTriggered ? (
              <>
                <div className="w-24 h-24 bg-rose-600 rounded-full flex items-center justify-center mx-auto mb-8 animate-ping">
                  <AlertTriangle size={48} className="text-white" />
                </div>
                <h2 className="text-3xl font-black text-white mb-4 leading-tight">CRITICAL ALERT</h2>
                <p className="text-slate-400 mb-10">Suspicious heart rate detected. Are you alright?</p>
                
                <div className="mb-10">
                  <div className="text-sm font-bold text-slate-500 mb-2 uppercase tracking-tighter">Automatic Dispatch In</div>
                  <div className="text-7xl font-black text-rose-500 tabular-nums">{countdown}</div>
                </div>

                <button 
                  onClick={() => setIsAlerting(false)}
                  className="w-full bg-emerald-600 py-5 rounded-2xl text-xl font-bold text-white shadow-xl shadow-emerald-900/30"
                >
                  Yes, I'm fine
                </button>
              </>
            ) : (
              <>
                <div className="w-24 h-24 bg-rose-600 rounded-full flex items-center justify-center mx-auto mb-8 shadow-[0_0_40px_rgba(225,29,72,0.6)]">
                  <Bell size={40} className="text-white" />
                </div>
                <h2 className="text-3xl font-black text-white mb-4">DISPATCHED</h2>
                <p className="text-slate-300 mb-6">Emergency services and your {emergencyContacts.length} contacts have been notified with your GPS coordinates.</p>
                <div className="bg-slate-800 p-4 rounded-xl mb-8">
                  <div className="text-xs text-rose-400 font-bold uppercase mb-2">Notifying Contacts:</div>
                  {emergencyContacts.map(c => <div key={c.id} className="text-sm mb-1">• {c.name} ({c.phone})</div>)}
                </div>
                <button 
                  onClick={() => { setIsAlerting(false); setIsEmergencyTriggered(false); }}
                  className="w-full border-2 border-slate-700 py-4 rounded-2xl font-bold text-slate-400"
                >
                  Dismiss
                </button>
              </>
            )}
          </div>
        </div>
      )}
    </div>
  );
};

export default App;
